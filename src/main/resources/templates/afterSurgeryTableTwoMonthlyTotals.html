<!-- src/main/resources/templates/afterSurgeryTableOneMonthlyTotals.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="zh">
<head>
    <meta charset="UTF-8" />
    <title th:text="${year} + ' 年（月度汇总）'">月度汇总</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="p-3">

<div th:replace="fragments/navbar :: navbar"></div>

<div class="container mt-4">

    <!-- Year selector -->
    <form class="row g-2 align-items-center mb-3" th:action="@{/afterSurgeryTableTwo/monthly-totals}" method="get">
        <div class="col-auto">
            <label for="yearSelect" class="col-form-label">选择年份</label>
        </div>
        <div class="col-auto">
            <select id="yearSelect" name="year" class="form-select" th:onchange="this.form.submit()">
                <option th:each="y : ${years}"
                        th:value="${y}"
                        th:text="${y}"
                        th:selected="${y} == ${year}">
                </option>
            </select>
        </div>
        <div class="col-auto d-none">
            <button class="btn btn-primary" type="submit">查看</button>
        </div>
    </form>

    <!-- Heading + Export buttons -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="m-0" th:text="${year} + ' 年（月度汇总）'"></h3>
        <div class="d-flex gap-2">
            <button id="exportExcelBtn" type="button" class="btn btn-success me-2">导出 Excel</button>
            <button id="exportCsvBtn"   type="button" class="btn btn-primary">导出 CSV</button>
        </div>
    </div>

    <!-- Data table (what you see is what gets exported) -->
    <table id="monthlyTable" class="table table-sm table-bordered align-middle">
        <thead class="table-light">
        <tr>
            <th>月份</th>
            <th>恶心呕吐</th>
            <th>头晕</th>
            <th>恶心呕吐头晕</th>
            <th>皮肤瘙痒</th>
            <th>过敏性皮疹</th>
            <th>麻醉恢复迟滞</th>
            <th>穿刺部位异常</th>
            <th>腹胀</th>
            <th>气插不适</th>
            <th>胃脘痛</th>
            <th>瞻望</th>
            <th>心胸不适</th>
            <th>止血带反应</th>
            <th>其他</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="m : ${monthlyTotals}">
            <td th:text="${#numbers.formatInteger(m.month(),2)}"></td>
            <td th:text="${m.totalNumOfNauseaAndVomiting()}"></td>
            <td th:text="${m.totalNumOfDizziness()}"></td>
            <td th:text="${m.totalNumOfNauseaAndVomitingAndDizziness()}"></td>
            <td th:text="${m.totalNumOfItching()}"></td>
            <td th:text="${m.totalNumOfAllergicRash()}"></td>
            <td th:text="${m.totalNumOfProlongedAnestheticRecovery()}"></td>
            <td th:text="${m.totalNumOfPunctureSiteAbnormality()}"></td>
            <td th:text="${m.totalNumOfAbdominalDistension()}"></td>
            <td th:text="${m.totalNumOfEndotrachealIntubationDiscomfort()}"></td>
            <td th:text="${m.totalNumOfEpigastricPain()}"></td>
            <td th:text="${m.totalNumOfDelirium()}"></td>
            <td th:text="${m.totalNumOfChestDiscomfort()}"></td>
            <td th:text="${m.totalNumOfTourniquetReaction()}"></td>
            <td th:text="${m.totalNumOfOther()}"></td>
        </tr>
        </tbody>
    </table>

    <!-- Charts -->
    <hr class="my-4" />
    <h5 class="mb-3">月度趋势图</h5>
    <canvas id="monthlyChart" height="100"></canvas>

    <h5 class="mt-5 mb-3">月度柱状图</h5>
    <canvas id="monthlyBar" height="110"></canvas>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Build chart data from Thymeleaf variables -->
<script th:inline="javascript">
    /*<![CDATA[*/
      const labels = [];
      const totalNumOfNauseaAndVomiting = [];
      const totalNumOfDizziness = [];
      const totalNumOfNauseaAndVomitingAndDizziness = [];
      const totalNumOfItching = [];
      const totalNumOfAllergicRash = [];
      const totalNumOfProlongedAnestheticRecovery = [];
      const totalNumOfPunctureSiteAbnormality = [];
      const totalNumOfAbdominalDistension = [];
      const totalNumOfEndotrachealIntubationDiscomfort = [];
      const totalNumOfEpigastricPain = [];
      const totalNumOfDelirium = [];
      const totalNumOfChestDiscomfort = [];
      const totalNumOfTourniquetReaction = [];
      const totalNumOfOther = [];

      /*[# th:each="m : ${monthlyTotals}"]*/
      (function(){
        const mm = /*[[${m.month}]]*/ 1;                 // Integer 1..12
        labels.push(String(mm).padStart(2,'0'));          // '01'..'12'
        totalNumOfNauseaAndVomiting.push(/*[[${m.totalNumOfNauseaAndVomiting}]]*/ 0);
        totalNumOfDizziness.push(/*[[${m.totalNumOfDizziness}]]*/ 0);
        totalNumOfNauseaAndVomitingAndDizziness.push(/*[[${m.totalNumOfNauseaAndVomitingAndDizziness}]]*/ 0);
        totalNumOfItching.push(/*[[${m.totalNumOfItching}]]*/ 0);
        totalNumOfAllergicRash.push(/*[[${m.totalNumOfAllergicRash}]]*/ 0);
        totalNumOfProlongedAnestheticRecovery.push(/*[[${m.totalNumOfProlongedAnestheticRecovery}]]*/ 0);
        totalNumOfPunctureSiteAbnormality.push(/*[[${m.totalNumOfPunctureSiteAbnormality}]]*/ 0);
        totalNumOfAbdominalDistension.push(/*[[${m.totalNumOfAbdominalDistension}]]*/ 0);
        totalNumOfEndotrachealIntubationDiscomfort.push(/*[[${m.totalNumOfEndotrachealIntubationDiscomfort}]]*/ 0);
        totalNumOfEpigastricPain.push(/*[[${m.totalNumOfEpigastricPain}]]*/ 0);
        totalNumOfDelirium.push(/*[[${m.totalNumOfDelirium}]]*/ 0);
        totalNumOfChestDiscomfort.push(/*[[${m.totalNumOfChestDiscomfort}]]*/ 0);
        totalNumOfTourniquetReaction.push(/*[[${m.totalNumOfTourniquetReaction}]]*/ 0);
        totalNumOfOther.push(/*[[${m.totalNumOfOther}]]*/ 0);
      })();
      /*[/]*/

      // Line chart
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels.map(m => m + '月'),
          datasets: [
                { label: '恶心呕吐', data: totalNumOfNauseaAndVomiting, borderColor: '#0d6efd', tension: 0.2, fill: false },   // Blue
                { label: '头晕', data: totalNumOfDizziness, borderColor: '#198754', tension: 0.2, fill: false },              // Green
                { label: '恶心呕吐头晕', data: totalNumOfNauseaAndVomitingAndDizziness, borderColor: '#ffc107', tension: 0.2, fill: false }, // Yellow
                { label: '皮肤瘙痒', data: totalNumOfItching, borderColor: '#dc3545', tension: 0.2, fill: false },            // Red
                { label: '过敏性皮疹', data: totalNumOfAllergicRash, borderColor: '#6f42c1', tension: 0.2, fill: false },     // Purple
                { label: '麻醉恢复迟滞', data: totalNumOfProlongedAnestheticRecovery, borderColor: '#fd7e14', tension: 0.2, fill: false }, // Orange
                { label: '穿刺部位异常', data: totalNumOfPunctureSiteAbnormality, borderColor: '#20c997', tension: 0.2, fill: false },     // Teal
                { label: '腹胀', data: totalNumOfAbdominalDistension, borderColor: '#0dcaf0', tension: 0.2, fill: false },   // Cyan
                { label: '气插不适', data: totalNumOfEndotrachealIntubationDiscomfort, borderColor: '#6610f2', tension: 0.2, fill: false }, // Indigo
                { label: '胃脘痛', data: totalNumOfEpigastricPain, borderColor: '#d63384', tension: 0.2, fill: false },      // Pink
                { label: '瞻望', data: totalNumOfDelirium, borderColor: '#1980ff', tension: 0.2, fill: false },              // Bright Blue
                { label: '心胸不适', data: totalNumOfChestDiscomfort, borderColor: '#e83e8c', tension: 0.2, fill: false },   // Magenta
                { label: '止血带反应', data: totalNumOfTourniquetReaction, borderColor: '#a0522d', tension: 0.2, fill: false }, // Brown
                { label: '其他', data: totalNumOfOther, borderColor: '#17a2b8', tension: 0.2, fill: false }                  // Light Teal
          ]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: false },
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
        }
      });

      // Bar chart
      const barCtx = document.getElementById('monthlyBar').getContext('2d');
      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: labels.map(m => m + '月'),
          datasets: [
                { label: '恶心呕吐', data: totalNumOfNauseaAndVomiting,
                  backgroundColor: 'rgba(13,110,253,0.35)', borderColor: '#0d6efd', borderWidth: 1 },   // Blue

                { label: '头晕', data: totalNumOfDizziness,
                  backgroundColor: 'rgba(25,135,84,0.35)', borderColor: '#198754', borderWidth: 1 },    // Green

                { label: '恶心呕吐头晕', data: totalNumOfNauseaAndVomitingAndDizziness,
                  backgroundColor: 'rgba(255,193,7,0.45)', borderColor: '#ffc107', borderWidth: 1 },    // Yellow

                { label: '皮肤瘙痒', data: totalNumOfItching,
                  backgroundColor: 'rgba(220,53,69,0.35)', borderColor: '#dc3545', borderWidth: 1 },    // Red

                { label: '过敏性皮疹', data: totalNumOfAllergicRash,
                  backgroundColor: 'rgba(111,66,193,0.35)', borderColor: '#6f42c1', borderWidth: 1 },   // Purple

                { label: '麻醉恢复迟滞', data: totalNumOfProlongedAnestheticRecovery,
                  backgroundColor: 'rgba(253,126,20,0.35)', borderColor: '#fd7e14', borderWidth: 1 },   // Orange

                { label: '穿刺部位异常', data: totalNumOfPunctureSiteAbnormality,
                  backgroundColor: 'rgba(32,201,151,0.35)', borderColor: '#20c997', borderWidth: 1 },   // Teal

                { label: '腹胀', data: totalNumOfAbdominalDistension,
                  backgroundColor: 'rgba(13,202,240,0.35)', borderColor: '#0dcaf0', borderWidth: 1 },   // Cyan

                { label: '气插不适', data: totalNumOfEndotrachealIntubationDiscomfort,
                  backgroundColor: 'rgba(214,51,132,0.35)', borderColor: '#d63384', borderWidth: 1 },   // Pink

                { label: '胃脘痛', data: totalNumOfEpigastricPain,
                  backgroundColor: 'rgba(40,167,69,0.35)', borderColor: '#28a745', borderWidth: 1 },    // Bright Green

                { label: '瞻望', data: totalNumOfDelirium,
                  backgroundColor: 'rgba(23,162,184,0.35)', borderColor: '#17a2b8', borderWidth: 1 },   // Light Teal

                { label: '心胸不适', data: totalNumOfChestDiscomfort,
                  backgroundColor: 'rgba(102,16,242,0.35)', borderColor: '#6610f2', borderWidth: 1 },   // Indigo

                { label: '止血带反应', data: totalNumOfTourniquetReaction,
                  backgroundColor: 'rgba(160,82,45,0.35)', borderColor: '#a0522d', borderWidth: 1 },    // Brown

                { label: '其他', data: totalNumOfOther,
                  backgroundColor: 'rgba(128,128,128,0.35)', borderColor: '#808080', borderWidth: 1 }   // Gray
          ]


        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          interaction: { mode: 'nearest', axis: 'x', intersect: false },
          scales: {
            y: { beginAtZero: true, ticks: { precision: 0 } },
            x: { stacked: false }
          }
        }
      });
    /*]]>*/
</script>

<!-- Robust SheetJS loader: primary jsDelivr, fallback unpkg -->
<script>
    (function loadSheetJS(){
      if (window.XLSX) return;
      var s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
      s.onload = function(){ console.log("SheetJS loaded"); };
      s.onerror = function(){
        console.warn("jsDelivr failed, trying unpkg...");
        var s2 = document.createElement('script');
        s2.src = "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js";
        s2.onload = function(){ console.log("SheetJS loaded (fallback)"); };
        s2.onerror = function(){ console.error("Failed to load SheetJS from both CDNs."); };
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    })();
</script>

<!-- Export handlers: CSV (always available) + Excel (uses SheetJS if loaded) -->
<script th:inline="javascript">
    /*<![CDATA[*/
      // Shared: build CSV string from the live table
      function buildCSVFromTable(table) {
        return Array.from(table.querySelectorAll('tr')).map(tr =>
          Array.from(tr.querySelectorAll('th,td'))
            .map(td => {
              const t = td.innerText.replaceAll('"','""');
              return (t.includes(',') || t.includes('"') || t.includes('\n')) ? `"${t}"` : t;
            })
            .join(',')
        ).join('\n');
      }

      // CSV export (adds UTF-8 BOM so Excel opens Chinese correctly)
      document.getElementById('exportCsvBtn')?.addEventListener('click', function () {
        const table = document.getElementById('monthlyTable');
        if (!table) return;

        const year = /*[[${year}]]*/ 2025;
        const csv = buildCSVFromTable(table);
        const csvWithBom = '\uFEFF' + csv; // BOM

        const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `AfterSurgeryTableTwo-月度汇总-${year}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // Excel export; falls back to CSV if SheetJS failed to load (CSP / network)
      document.getElementById('exportExcelBtn')?.addEventListener('click', function () {
        const table = document.getElementById('monthlyTable');
        if (!table) return;

        const year = /*[[${year}]]*/ 2025;

        if (typeof XLSX === 'undefined') {
          // Fallback to CSV automatically
          const csv = buildCSVFromTable(table);
          const csvWithBom = '\uFEFF' + csv;
          const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8;' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `AfterSurgeryTableTwo-月度汇总-${year}.csv`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          return;
        }

        // Use SheetJS to make .xlsx from the table
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table, { raw: true });
        ws['!cols'] = [{ wch: 6 }, { wch: 14 }, { wch: 14 }, { wch: 14 }, { wch: 14 }];
        XLSX.utils.book_append_sheet(wb, ws, '月度汇总');

        XLSX.writeFile(wb, `AfterSurgeryTableThree-月度汇总-${year}.xlsx`);
      });
    /*]]>*/
</script>

<!-- (If your CSP blocks CDNs, host SheetJS locally and replace the loader above with:) -->
<!-- <script th:src="@{/js/xlsx.full.min.js}"></script> -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
